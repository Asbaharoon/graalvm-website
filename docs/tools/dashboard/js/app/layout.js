define((function(){"use strict";var t=function(t,e,o){this._layoutContext=t,this._optLinkLength=e,this._initialTemp=o};return t.PAD_FACTOR=1.2,t.INIT_TEMP_FACTOR=.25,t.ITERATIONS=200,t.forceDirectedLayout=function(e){var o=t.getMaxNodeBounds(e),n=e.getNodeCount(),i=n*(t.PAD_FACTOR*o.w)*(t.PAD_FACTOR*o.h),s=t.INIT_TEMP_FACTOR*Math.sqrt(i),r=e.getLayoutAttributes(),a=r&&r.optimalLinkLength?parseFloat(r.optimalLinkLength):Math.sqrt(i/n),h=new t(e,a,s);h.layoutNodes(),h.layoutLinks(),h.positionNodeLabels(),h.positionLinkLabels()},t.prototype.layoutNodes=function(){this.initForceDirectedPositions();for(var e=t.ITERATIONS,o=this._initialTemp,n=0;n<e;n++)this.runForceDirectedIteration(o),o=this._initialTemp*(1-(n+1)/e)},t.prototype.runForceDirectedIteration=function(t){for(var e=this._layoutContext.getNodeCount(),o=0;o<e;o++){(u=this._layoutContext.getNodeByIndex(o)).disp={x:0,y:0};for(var n=0;n<e;n++)if(o!=n){var i=this._layoutContext.getNodeByIndex(n),s=this._subtractVectors(u.getPosition(),i.getPosition()),r=this._vectorLength(s),a=this._optLinkLength*this._optLinkLength/r;u.disp=this._addVectors(u.disp,this._scaleVector(s,a/r))}}for(var h=this._layoutContext.getLinkCount(),d=0;d<h;d++){var y=this._layoutContext.getLinkByIndex(d),u=this._getNodeAtCurrentLevel(y.getStartId());i=this._getNodeAtCurrentLevel(y.getEndId());if(u&&i){s=this._subtractVectors(u.getPosition(),i.getPosition());var g=(r=this._vectorLength(s))*r/this._optLinkLength;u.disp=this._subtractVectors(u.disp,this._scaleVector(s,g/r)),i.disp=this._addVectors(i.disp,this._scaleVector(s,g/r))}}for(o=0;o<e;o++){u=this._layoutContext.getNodeByIndex(o);this._addGravity(u);r=this._vectorLength(u.disp);var c=this._addVectors(u.getPosition(),this._scaleVector(u.disp,Math.min(r,t)/r));u.setPosition(c)}},t.prototype._addGravity=function(t){var e=this._vectorLength(t.getPosition()),o=e*e/this._optLinkLength;t.disp=this._subtractVectors(t.disp,this._scaleVector(t.getPosition(),o/e*.2))},t.prototype.initForceDirectedPositions=function(){for(var t=this._layoutContext.getNodeCount(),e=2*Math.PI/t,o=this._optLinkLength,n=0;n<t;n++){var i=o*Math.cos(e*n),s=o*Math.sin(e*n);this._layoutContext.getNodeByIndex(n).setPosition({x:i,y:s})}},t.prototype._vectorLength=function(t){return Math.sqrt(t.x*t.x+t.y*t.y)},t.prototype._scaleVector=function(t,e){return{x:t.x*e,y:t.y*e}},t.prototype._addVectors=function(t,e){return{x:t.x+e.x,y:t.y+e.y}},t.prototype._subtractVectors=function(t,e){return{x:t.x-e.x,y:t.y-e.y}},t.prototype._getNodeAtCurrentLevel=function(t){var e;do{if(!t)return null;t=(e=this._layoutContext.getNodeById(t)).getContainerId()}while(!e.disp);return e},t.prototype.layoutLinks=function(){for(var t=0;t<this._layoutContext.getLinkCount();t++){var e=this._layoutContext.getLinkByIndex(t);e.setPoints(this.getEndpoints(e))}},t.prototype.getEndpoints=function(t){var e=this._layoutContext.getNodeById(t.getStartId()),o=this._layoutContext.getNodeById(t.getEndId()),n=e.getPosition(),i=o.getPosition(),s=e.getContentBounds(),r=o.getContentBounds(),a=n.x+s.x+.5*s.w,h=n.y+s.y+.5*s.h,d=i.x+r.x+.5*r.w,y=i.y+r.y+.5*r.h;s={x:n.x+s.x,y:n.y+s.y,w:s.w,h:s.h},r={x:i.x+r.x,y:i.y+r.y,w:r.w,h:r.h};var u=this._findLinkNodeIntersection(s,a,h,d,y,t.getStartConnectorOffset()),g=this._findLinkNodeIntersection(r,d,y,a,h,t.getEndConnectorOffset());return[u.x,u.y,g.x,g.y]},t.prototype._findLinkNodeIntersection=function(t,e,o,n,i,s){var r=Math.atan2(i-o,n-e),a=Math.atan2(t.h,t.w),h=Math.PI-a,d=-a,y=0,u=0;return r>=-h&&r<=d?(y=t.x+.5*t.w+Math.tan(Math.PI/2-r)*(.5*-t.h),u=t.y):r<=h&&r>=a?(y=t.x+.5*t.w+Math.tan(Math.PI/2-r)*(.5*t.h),u=t.y+t.h):r<=a&&r>=d?(y=t.x+t.w,u=t.y+.5*t.h+Math.tan(r)*(.5*t.w)):(y=t.x,u=t.y+.5*t.h+Math.tan(r)*(.5*-t.w)),s&&(y+=Math.cos(r)*s,u+=Math.sin(r)*s),{x:y,y:u}},t.prototype.positionNodeLabels=function(){for(var t=0;t<this._layoutContext.getNodeCount();t++){var e=this._layoutContext.getNodeByIndex(t);if(e.getLabelBounds()){var o=e.getContentBounds(),n=e.getPosition(),i=o.x+n.x+.5*o.w,s=o.y+n.y+o.h;e.setLabelPosition({x:i,y:s}),e.setLabelHalign("center")}}},t.prototype.positionLinkLabels=function(t){for(var e=0;e<this._layoutContext.getLinkCount();e++){var o=this._layoutContext.getLinkByIndex(e),n=o.getLabelBounds();if(n){var i=o.getPoints();if(i.length>=4){var s=i[0],r=i[i.length-2],a=i[1],h=s+.5*(r-s),d=a+.5*(i[i.length-1]-a-n.h);o.setLabelPosition({x:h,y:d}),o.setLabelHalign("center")}}}},t.getMaxNodeBounds=function(t){for(var e=t.getNodeCount(),o=0,n=0,i=0;i<e;i++){var s=t.getNodeByIndex(i).getContentBounds();o=Math.max(s.w,o),n=Math.max(s.h,n)}return{x:0,y:0,w:o,h:n}},t}));